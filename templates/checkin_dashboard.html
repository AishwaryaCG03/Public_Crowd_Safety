{% extends "layout.html" %}
{% block content %}
<div class="content-section">
  <h1 class="mb-4">Check-In & Capacity</h1>
  <div id="alert-toast" class="alert" style="display:none"></div>

  <div class="row">
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Zones & Capacity</h5>
        </div>
        <div class="card-body">
          {% if zones %}
          <table class="table" id="capacity-table">
            <thead>
              <tr>
                <th>Zone</th>
                <th>Current</th>
                <th>Max</th>
                <th>%</th>
              </tr>
            </thead>
            <tbody>
            {% for z in zones %}
              <tr data-zone-id="{{ z.id }}">
                <td>{{ z.name }}</td>
                <td class="current-capacity">{{ z.current_capacity }}</td>
                <td>{{ z.max_capacity }}</td>
                <td class="capacity-percentage">{{ '%.1f' % z.capacity_percentage }}%</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
          {% else %}
            <p class="text-muted">No zones yet. Create one below.</p>
          {% endif %}
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0">Create Zone</h5>
        </div>
        <div class="card-body">
          <form action="{{ url_for('create_zone', event_id=event.id) }}" method="post">
            {{ zone_form.hidden_tag() }}
            <div class="mb-3">{{ zone_form.name.label }} {{ zone_form.name(class='form-control') }}</div>
            <div class="mb-3">{{ zone_form.max_capacity.label }} {{ zone_form.max_capacity(class='form-control') }}</div>
            <div class="mb-3">{{ zone_form.description.label }} {{ zone_form.description(class='form-control') }}</div>
            <div class="mb-3">{{ zone_form.coordinates.label }} {{ zone_form.coordinates(class='form-control') }}</div>
            {{ zone_form.submit(class='btn btn-secondary') }}
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">Register Attendee & QR</h5>
        </div>
        <div class="card-body">
          <form action="{{ url_for('checkin_dashboard', event_id=event.id) }}" method="post">
            {{ attendee_form.hidden_tag() }}
            <div class="mb-3">{{ attendee_form.name.label }} {{ attendee_form.name(class='form-control') }}</div>
            <div class="mb-3">{{ attendee_form.email.label }} {{ attendee_form.email(class='form-control') }}</div>
            <div class="mb-3">{{ attendee_form.phone.label }} {{ attendee_form.phone(class='form-control') }}</div>
            {{ attendee_form.submit(class='btn btn-success') }}
          </form>
          {% if qr_image %}
            <hr/>
            <p class="text-muted">Scan this QR for check-in:</p>
            <img src="{{ qr_image }}" alt="Attendee QR" class="img-thumbnail" style="max-width: 200px;"/>
          {% endif %}
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">Manual Check-In / Check-Out</h5>
        </div>
        <div class="card-body">
          <div id="checkin-feedback" class="alert" style="display:none"></div>
          <form id="checkin-form">
            <div class="mb-3">
              <label for="qr_code" class="form-label">QR Code</label>
              <input type="text" id="qr_code" class="form-control" placeholder="Paste scanned QR value" required />
            </div>
            <div class="mb-3">
              <label for="zone_id" class="form-label">Zone</label>
              <select id="zone_id" class="form-select" required>
                {% for z in zones %}
                  <option value="{{ z.id }}">{{ z.name }}</option>
                {% endfor %}
              </select>
            </div>
            <button class="btn btn-info" type="submit"><i class="fas fa-sign-in-alt"></i> Check In</button>
          </form>
          <hr/>
          <form id="checkout-form">
            <div class="mb-3">
              <label for="qr_code_out" class="form-label">QR Code</label>
              <input type="text" id="qr_code_out" class="form-control" placeholder="Paste scanned QR value" required />
            </div>
            <button class="btn btn-outline-info" type="submit"><i class="fas fa-sign-out-alt"></i> Check Out</button>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">Contact Trace</h5>
        </div>
        <div class="card-body">
          <form id="contact-trace-form" class="row g-2 align-items-end">
            <div class="col-md-6">
              <label for="ct_zone_id" class="form-label">Zone</label>
              <select id="ct_zone_id" class="form-select" required>
                {% for z in zones %}
                  <option value="{{ z.id }}">{{ z.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label for="ct_minutes" class="form-label">Lookback Minutes</label>
              <input type="number" id="ct_minutes" class="form-control" value="60" min="5" max="720" required />
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-warning w-100"><i class="fas fa-search"></i> Trace</button>
            </div>
          </form>
          <div id="contact-trace-feedback" class="alert mt-3" style="display:none"></div>
          <div class="table-responsive mt-2" id="contact-trace-results" style="display:none">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Check-In</th>
                  <th>Check-Out</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    initCheckinDashboard({{ event.id }});
    initAlertNotifications({{ event.id }});
  });
  </script>
{% endblock content %}
